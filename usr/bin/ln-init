
#!/bin/bash

# Initialize livenet environment
# Build livenet pool
# create volume
# install dhcp-server
# configre trivial ftp

#Initialize zpool for livenet

#echo "Check livenet parameteres in /etc/defaul/livenet"

#vi /etc/default/livenet

. /etc/default/livenet

#Inizializza da dispositivo vergine
#
initblk()
{
	echo "Indica il percorso completo di un dispositivo a blocchi da dedicare per Livenet"
	read -p "Percorso assoluto: " blkzfs
    echo $blkzfs
	#controllo se il dispositivo esiste
	if [ -b "$blkzfs" ]; then
		#se esiste, controllo se esiste il punto di mount
		if [ -d "/livenet" ]; then
		 # Control will enter here if /livenet exists.
			echo "Il  punto di mount predefinito esiste, rimuovere /livenet prima di proseguire"
		else
		  # Control will enter here if /livenet not exists.
			echo "Pulizia del dispositivo"
			echo "Rimozione del pool ${LNPZFS} se esistente..."
			zpool destroy ${LNPZFS}
			echo "Pulizia del disco..."
			sgdisk --clear -g ${blkzfs}
			echo "Creazione partizione primaria"
			sgdisk -a1 -n2:34:2047  -t2:EF02 ${blkzfs}
			echo "Creazione del pool ${blkzfs}..."
			zpool create LNPZFS ${blkzfs}	
			
			echo "creazione dei volumi  di default"
	
			echo zfs create ${LNPZFS}/${LNVZFS}
      			zfs create ${LNPZFS}/${LNVZFS}
			echo zfs create ${LNPZFS}/${LNVZFS}/images
			zfs create ${LNPZFS}/${LNVZFS}/images
			echo zfs create ${LNPZFS}/${LNVZFS}/boot
			zfs create ${LNPZFS}/${LNVZFS}/boot
	
		fi
	
	else
		echo "Il dispositivo indicato non esiste"

	fi

}

usage()
{
		 cat << EOF
        Usage: ln-init <options>

        Options:
        --h: show this messages
        --show: show curret livenet configuration
        --initblk: initialize device block for livenet storage
        --version,-v

EOF
}

while true; do
   case $1 in
      -h|--help)
         usage
         exit 0
         ;;
      -v|--version)
        apt-cache show livenet-server | sed -n 's/^Version:.\([0-9\.]\+\)-.*/\1/p'
        exit 0
         ;;
      --initblk)
		initblk
		exit 0
		;;
      --show)
      #show current configuration livenet
      #path of storage
      #network configuration
        exit 0
        ;;
	   *)
        #shift
        if [ -n "$1" ]; then
            echo "Error: bad argument"
            exit 1
        fi
        break
        ;;
   esac
   shift
done

usage
